<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>About - Streak Overlay for Dead by Daylight</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    code { background-color: rgba(255,255,255,.1); padding: 2px 4px; border-radius: 2px; }
    #release-notes-container {
      background-color: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }
    #release-notes {
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.3) transparent;
    }
    #release-notes::-webkit-scrollbar {
      width: 8px;
    }
    #release-notes::-webkit-scrollbar-track {
      background: transparent;
    }
    #release-notes::-webkit-scrollbar-thumb {
      background-color: rgba(255,255,255,.3);
      border-radius: 4px;
    }
    #release-notes::-webkit-scrollbar-thumb:hover {
      background-color: rgba(255,255,255,.5);
    }
    .version-section {
      border-top: 1px solid rgba(255,255,255,.1);
      padding-top: 16px;
      margin-top: 24px;
    }
  </style>
  </head>
<body>
  <div class="container py-3">
    <h1 class="mb-3">About</h1>
    <p>Streak Overlay for Dead by Daylight helps streamers create and manage win-streak overlays.</p>
    <p class="text-body-secondary">Closing this window will minimize the app to the tray. To quit the app, open the tray icon and click "Quit".</p>
    <h6 class="mt-4">OBS setup</h6>
    <ol class="mb-3">
      <li>Add a <strong>Browser Source</strong> with the URL <code id="source-url"></code>. The width and height should be set to 1920x1080. No custom CSS should be applied.</li>
      <li>Add a <strong>Custom Browser Dock</strong> (under the "Tools" menu) with the URL <code id="dock-url"></code>.</li>
    </ol>
    <p class="text-body-secondary">If OBS was already open when you started the app, you may need to refresh the browser source and dock in OBS. To refresh the browser source, select the source and click "Refresh" in the actions menu. To refresh the browser dock, right-click anywhere in the dock and select "Refresh".</p>
    <div class="mt-3">
      <button id="check-updates" class="btn btn-primary">Check for updates</button>
    </div>
    <div class="version-section">
      <div class="d-flex align-items-center gap-2 mb-2">
        <span class="small text-body-secondary">Version:</span>
        <span class="small fw-semibold" id="app-version">loading…</span>
      </div>
      <div class="mb-2">
        <span class="small fw-semibold">What's new in this version:</span>
      </div>
      <div id="release-notes-container">
        <div id="release-notes" style="max-height: 200px; overflow-y: auto; line-height: 1.5;">
          <span class="text-body-secondary small">Loading release notes…</span>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.getElementById('check-updates').addEventListener('click', () => {
      fetch('/api/check-updates', { method: 'POST' })
        .then(async r => {
          let body = null;
          try { body = await r.json(); } catch {}
          if (!r.ok || (body && body.ok === false)) {
            const msg = (body && (body.error || body.message)) || `HTTP ${r.status} ${r.statusText}`;
            throw new Error(msg);
          }
          return body;
        })
        .then(({ updateAvailable, latestVersion }) => {
          alert(updateAvailable ? `Update available: v${latestVersion}` : 'You are on the latest version.');
        })
        .catch(err => {
          const message = err && err.message ? err.message : String(err || 'Unknown error');
          alert(`Failed to check for updates:\n${message}`);
        });
    });
    fetch('/version')
      .then(r => r.json())
      .then(({ version }) => {
        document.getElementById('app-version').textContent = version || 'unknown';
        // Fetch release notes for this version
        if (version) {
          // Escape HTML to prevent XSS
          const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };
          
          fetch('/api/release-notes')
            .then(r => r.json())
            .then(({ ok, body, error }) => {
              const notesEl = document.getElementById('release-notes');
              if (ok && body) {
                // Convert markdown-style line breaks to HTML
                const formattedNotes = body
                  .split('\n')
                  .map(line => {
                    // Convert markdown headers to HTML
                    if (line.startsWith('### ')) {
                      return `<h6 class="mt-2 mb-1">${escapeHtml(line.substring(4))}</h6>`;
                    } else if (line.startsWith('## ')) {
                      return `<h6 class="mt-2 mb-1 fw-bold">${escapeHtml(line.substring(3))}</h6>`;
                    } else if (line.startsWith('# ')) {
                      return `<h6 class="mt-2 mb-1 fw-bold">${escapeHtml(line.substring(2))}</h6>`;
                    } else if (line.startsWith('- ') || line.startsWith('* ')) {
                      return `<div class="ms-2">• ${escapeHtml(line.substring(2))}</div>`;
                    } else if (line.trim() === '') {
                      return '<br>';
                    } else {
                      return `<div>${escapeHtml(line)}</div>`;
                    }
                  })
                  .join('');
                notesEl.innerHTML = formattedNotes || '<span class="text-body-secondary small">No release notes available.</span>';
              } else {
                const errorMsg = error ? escapeHtml(error) : '';
                notesEl.innerHTML = `<span class="text-body-secondary small">Unable to load release notes${errorMsg ? ': ' + errorMsg : ''}.</span>`;
              }
            })
            .catch(err => {
              document.getElementById('release-notes').innerHTML = '<span class="text-body-secondary small">Unable to load release notes.</span>';
            });
        }
      })
      .catch(() => {
        document.getElementById('app-version').textContent = 'unknown';
      });
    const port = location.port;
    document.getElementById('source-url').textContent = `http://localhost:${port}/source`;
    document.getElementById('dock-url').textContent = `http://localhost:${port}/dock`;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

